<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#2f4595" />
<title>Registo de Cagarros / Cory's Shearwater Rescue</title>
<style>
  :root { --maxw: 520px; --spea-blue: #2f4595; }
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    margin: 0 auto;
    max-width: var(--maxw);
    background: var(--spea-blue);
    color: #fff;
  }
  h2 { text-align: center; margin: 12px 0 6px; }
  p.subtitle { text-align:center; margin:0 0 16px; color:#dbe1ff; font-size:14px; }

  label { font-weight: 600; display: block; margin-top: 14px; }
  select, input, textarea, button {
    width: 100%; padding: 12px; margin-top: 6px; font-size: 16px;
    border:1px solid #ced4da; border-radius: 8px; background:#fff; color:#000;
  }
  textarea { resize: vertical; min-height: 72px; }
  button { background-color: #28a745; color: #fff; border: none; cursor: pointer; font-weight: 700; border-radius: 8px; }
  button.secondary { background:#0d6efd; margin-top:10px; }
  button.ghost { background:transparent; border:2px solid #fff; color:#fff; }
  button:disabled { background-color: #adb5bd; cursor:not-allowed; }

  #mensagem { margin-top: 18px; text-align: center; font-weight: bold; min-height: 24px; }
  .hint { font-size: 12px; color:#e0e0e0; margin-top:4px; }
  .hidden { display:none !important; }

  .statusbar { margin-bottom: 12px; padding:10px; border-radius:8px; font-weight:700; text-align:center; }
  .online  { background:#e6f4ea; color:#1e7e34; border:1px solid #c7efd3; }
  .offline { background:#fdecea; color:#a4252c; border:1px solid #f5c6cb; }
  .queue { font-size: 13px; text-align:center; color:#eee; margin-top:8px; }

  /* C√≥digo em destaque */
  .code-wrap { display:flex; justify-content:center; margin-top:12px; }
  .code-box {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 2.2rem; line-height: 1.2;
    background:#fff; border:3px dashed #28a745; color:#0b7a2a;
    padding: 14px 18px; border-radius: 12px; user-select: all; text-align:center;
    box-shadow: 0 3px 10px rgba(0,0,0,.15);
    min-width: 72%;
  }
  .code-actions { display:flex; justify-content:center; gap:10px; margin-top:8px; }
  .small-note { text-align:center; font-size:12px; color:#dbe1ff; margin-top:6px; }

  footer { margin: 28px 0 6px; display:flex; justify-content:center; }
  footer img { max-width: 160px; height:auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,.25)); opacity: 0.95; }
</style>
</head>
<body>

<h2> Registo de Cagarros<br/> Cory's Shearwater Rescue</h2>
<p class="subtitle">Formul√°rio bilingue ‚Äî Portuguese / English</p>

<div id="netStatus" class="statusbar hidden"></div>

<form id="cagarroForm" novalidate>
  <label for="nome">Nome / Name</label>
  <input type="text" id="nome" name="nome" placeholder="Digite o seu nome / Enter your name" required />

  <label for="estado">Estado / Status</label>
  <select id="estado" name="estado" required>
    <option value="">-- Escolher / Choose --</option>
    <option value="Vivo / Alive">Vivo / Alive</option>
    <option value="Morto / Dead">Morto / Dead</option>
    <option value="Ferido / Injured">Ferido / Injured</option>
    <option value="Oleado / Oiled">Oleado / Oiled</option>
  </select>

  <label for="local">Local / Location</label>
  <select id="local" name="local" required>
    <option value="">-- Selecionar / Select --</option>
    <option value="Sem localiza√ß√£o / No location">Sem localiza√ß√£o / No location</option>
    <option value="Hotel de Cagarro / Shearwater Hotel">Hotel de Cagarro / Shearwater Hotel</option>
    <option value="Fora da marina/Porto / Outside marina/Port">Fora da marina/Porto / Outside marina/Port</option>
  </select>

  <label for="observacoes">Observa√ß√µes / Observations</label>
  <textarea id="observacoes" name="observacoes" placeholder="Informa√ß√µes adicionais / Additional information"></textarea>

  <!-- GPS oculto + precis√£o -->
  <input type="hidden" id="latitude"  name="latitude" />
  <input type="hidden" id="longitude" name="longitude" />
  <input type="hidden" id="gpsAcc"    name="gpsAcc" />

  <button type="submit" id="sendBtn" disabled>üìç A obter localiza√ß√£o... / Getting location...</button>
  <div id="gpsHint" class="hint"></div>
</form>

<button id="flushBtn" class="secondary hidden">üì§ Enviar Pendentes / Send Pending</button>
<div id="queueInfo" class="queue"></div>

<p id="mensagem"></p>

<div id="codeArea" class="hidden">
  <div id="codeWrap" class="code-wrap">
    <div id="bigCode" class="code-box" title="Toque para selecionar / Tap to select"></div>
  </div>
  <div class="code-actions">
    <button id="copyBtn" class="ghost">üìã Copiar c√≥digo / Copy code</button>
  </div>
  <div id="codeNote" class="small-note">Guarde este c√≥digo. / Keep this code.</div>
</div>

<footer>
  <img src="./spea-logo-white.png" alt="SPEA" />
</footer>

<script>
  // Endpoint do Apps Script
  const scriptURL = "https://script.google.com/macros/s/AKfycbxx2ivVioZSzhFa--i-Lm6WofK--0DhZwNMczxgK0GVS3Z-aeMWISmptbxRkvNcn_v1/exec";

  // ===== GPS autom√°tico (exige ‚â§ 10 m, reinicia sozinho e envia precis√£o) =====
  document.addEventListener("DOMContentLoaded", () => {
    const REQUIRED_ACC = 10;     // metros
    const WATCH_MAX    = 30000;  // 30s por sess√£o
    const RETRY_GAP    = 1500;   // pausa entre sess√µes
    const STABLE_MS    = 2500;   // aguardar uns segundos antes de aceitar

    const latEl = document.getElementById("latitude");
    const lonEl = document.getElementById("longitude");
    const accEl = document.getElementById("gpsAcc");
    const btn   = document.getElementById("sendBtn");
    const hint  = document.getElementById("gpsHint");

    let watchId = null, timer = null, best = null, t0 = 0;

    function lockSend(txt){ btn.disabled = true;  btn.textContent = txt || "üìç A obter localiza√ß√£o..."; }
    function unlockSend(){  btn.disabled = false; btn.textContent = "Enviar / Submit"; }
    function showFix(f){
      latEl.value = f.lat.toFixed(6);
      lonEl.value = f.lon.toFixed(6);
      accEl.value = Math.round(f.acc); // envia em metros
      hint.textContent = `Precis√£o: ¬±${Math.round(f.acc)} m` + (f.acc<=REQUIRED_ACC ? " ‚úÖ" : ` ‚Äî a melhorar at√© ‚â§ ${REQUIRED_ACC} m‚Ä¶`);
    }
    function clearWatch(){
      try{ if (watchId!==null) navigator.geolocation.clearWatch(watchId); }catch(_){}
      watchId = null; if (timer){ clearTimeout(timer); timer = null; }
    }
    function startWatch(){
      clearWatch(); best=null; t0=Date.now();
      lockSend("üìç A obter localiza√ß√£o...");
      if (!("geolocation" in navigator)){
        hint.textContent = "Dispositivo sem geolocaliza√ß√£o.";
        return; // fica bloqueado
      }
      hint.textContent = `A procurar sat√©lites (alvo ‚â§ ${REQUIRED_ACC} m)‚Ä¶`;

      watchId = navigator.geolocation.watchPosition(
        pos => {
          const acc = pos.coords.accuracy || 9999;
          const fix = { lat: pos.coords.latitude, lon: pos.coords.longitude, acc };
          if (!best || acc < best.acc){ best = fix; showFix(best); }

          // S√≥ desbloqueia quando atingir ‚â§ 10 m e est√°vel
          if (best.acc <= REQUIRED_ACC && (Date.now()-t0) > STABLE_MS){
            hint.textContent = `GPS ok: ¬±${Math.round(best.acc)} m ‚úÖ`;
            unlockSend();
          } else {
            lockSend("üìç A melhorar precis√£o‚Ä¶");
          }
        },
        err => {
          clearWatch();
          hint.textContent = `Sem GPS preciso (${err.message}). A tentar novamente‚Ä¶`;
          setTimeout(startWatch, RETRY_GAP);
        },
        { enableHighAccuracy: true, timeout: WATCH_MAX, maximumAge: 0 }
      );

      // rein√≠cio autom√°tico da sess√£o
      timer = setTimeout(() => {
        clearWatch();
        if (!best) hint.textContent = "A tentar novamente obter fix‚Ä¶";
        setTimeout(startWatch, RETRY_GAP);
      }, WATCH_MAX);
    }

    // arranca e retoma automaticamente
    startWatch();
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) clearWatch(); else startWatch();
    });
  });

  // ===== Offline queue =====
  const LS_KEY = "cagarros_pendentes_v1";
  const netBar = document.getElementById("netStatus");
  const flushBtn = document.getElementById("flushBtn");
  const queueInfo = document.getElementById("queueInfo");
  function getQueue(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch(_){ return []; } }
  function setQueue(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); updateQueueUI(); }
  function addPending(payload){ const q = getQueue(); q.push({ payload, savedAt: new Date().toISOString() }); setQueue(q); }
  function updateQueueUI(){
    const qlen = getQueue().length;
    queueInfo.textContent = qlen > 0 ? `üóÇÔ∏è Pendentes: ${qlen}` : "";
    flushBtn.classList.toggle("hidden", qlen === 0);
  }
  function setNetBar(){
    netBar.classList.remove("hidden");
    if (navigator.onLine) { netBar.className = "statusbar online";  netBar.textContent = "Liga√ß√£o ativa / Online"; }
    else                  { netBar.className = "statusbar offline"; netBar.textContent = "Sem rede ‚Äî pendentes / Offline ‚Äî will be queued"; }
  }
  window.addEventListener("online", () => { setNetBar(); flushPending(); });
  window.addEventListener("offline", setNetBar);
  setNetBar(); updateQueueUI();

  // ===== √Årea do c√≥digo =====
  const codeArea = document.getElementById("codeArea");
  const bigCode  = document.getElementById("bigCode");
  const copyBtn  = document.getElementById("copyBtn");

  // ===== Submiss√£o =====
  document.getElementById("cagarroForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const btn = document.getElementById("sendBtn");
    const msg = document.getElementById("mensagem");
    btn.disabled = true; btn.textContent = "A enviar... / Sending...";

    codeArea.classList.add("hidden");
    bigCode.textContent = "";

    const payload = {
      nome: document.getElementById("nome").value,
      estado: document.getElementById("estado").value,
      local: document.getElementById("local").value,
      observacoes: document.getElementById("observacoes").value,
      latitude: document.getElementById("latitude").value,
      longitude: document.getElementById("longitude").value,
      gpsAcc: document.getElementById("gpsAcc").value   // <<< envia precis√£o (m)
    };

    try {
      const res = await fetch(scriptURL, { method: "POST", body: JSON.stringify(payload) });
      const text = await res.text();
      let data = null; try { data = JSON.parse(text); } catch(_) {}

      if (res.ok && data && data.status === "success") {
        msg.textContent = "‚úÖ Registo enviado! / Entry submitted!";
        bigCode.textContent = data.codigo || "";
        codeArea.classList.remove("hidden");
        e.target.reset();
      } else {
        addPending(payload);
        msg.innerHTML = "‚ö†Ô∏è N√£o foi poss√≠vel gravar agora. Guardado em Pendentes.";
      }
    } catch (err) {
      addPending(payload);
      msg.textContent = "üì¶ Sem rede: guardado em Pendentes / Saved offline.";
    } finally {
      btn.disabled = false; btn.textContent = "Enviar / Submit";
    }
  });

  // ===== Enviar Pendentes =====
  async function flushPending(){
    if (!navigator.onLine) return;
    const q = getQueue(); if (q.length === 0) return;
    flushBtn.disabled = true; flushBtn.textContent = "A enviar pendentes... / Sending...";
    let ok = 0, fail = 0; const newQ = [];
    for (const item of q) {
      try {
        const res = await fetch(scriptURL, { method: "POST", body: JSON.stringify(item.payload) });
        if (res.ok) ok++; else { fail++; newQ.push(item); }
      } catch(_) { fail++; newQ.push(item); }
    }
    setQueue(newQ);
    flushBtn.disabled = false; flushBtn.textContent = "üì§ Enviar Pendentes / Send Pending";
    const msg = document.getElementById("mensagem");
    if (ok>0) msg.textContent = `üì§ Enviados: ${ok} | Por enviar: ${newQ.length}`;
    if (fail>0 && ok===0) msg.textContent = "‚ö†Ô∏è Falha ao enviar pendentes.";
  }
  document.getElementById("flushBtn").addEventListener("click", flushPending);

  // ===== Copiar c√≥digo =====
  copyBtn.addEventListener("click", async (ev) => {
    ev.preventDefault();
    const code = bigCode.textContent.trim(); if (!code) return;
    try {
      await navigator.clipboard.writeText(code);
      const old = copyBtn.textContent;
      copyBtn.textContent = "‚úÖ Copiado!";
      setTimeout(() => copyBtn.textContent = old, 1400);
    } catch(_) {
      const r = document.createRange(); r.selectNodeContents(bigCode);
      const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
    }
  });

  bigCode.addEventListener("click", () => {
    const r = document.createRange(); r.selectNodeContents(bigCode);
    const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
  });
</script>

</body>
</html>
